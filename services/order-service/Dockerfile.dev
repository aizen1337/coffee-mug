# Stage 1: Build the Vite frontend
FROM node:20-alpine AS build

# Set working directory
WORKDIR /app

# Install dependencies
COPY package*.json tsconfig.json tsconfig.prod.json config.ts eslint.config.ts ./
COPY src ./src
COPY scripts ./scripts
COPY config ./config
COPY tests ./tests

RUN npm install
RUN npm run build

# Stage 2: Serve with Node.js
FROM node:20-alpine AS production

WORKDIR /app
# Copy package.json and install only production deps
COPY package*.json ./
RUN npm install --omit=dev

# Copy build output from the previous stage
COPY --from=build /app/dist ./dist
COPY --from=build /app/config ./dist/config

# Expose port
EXPOSE 1338

# Start the app (assuming an Express or similar server)
CMD ["npm", "start"]
